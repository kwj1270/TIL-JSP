에러 처리
=======================
# 1. 익셉션 직접 처리하기
기존 페이지가 동작중에 에러가 발생하면 웹 컨테이너가 생성한 에러화면을 띄워준다
[사진]
개발 과정에서는 이러한 에러 화면에 표시된 에러 내용을 보고 어떤 에러가 발생했는지 알 수 있어서
에러 화면을 보는 것이 도움이 된다.  
  
하지만 클라이언트의 입장에서 이러한 에러화면을 접했을 경우 해당 사이트를 신뢰하지 않게 된다.  
또한, 코드의 일부가 노출되기 때문에 보안 측면에서도 좋지 않다.  
  
그래서 개발자가 직접 에러에대한 처리를 하던가 에러 페이지를 생성해서         
클라이언트들에게 전보다는 나은 에러 화면을 보여줄 수 있다.      
## 1.1. 에러 처리
자바에서는 ```Try...catch```로 에러를 처리한다.  
이를 JSP 에서 그대로 사용한다고 보면 된다.   
   
**예시**
```
<%@ page contentType="text.html; charset=utf-8" %>
<html>
<head><title>파라미터 출력</title></head>
<body>

name 파라미터 값:
<% try{ %>
<%=request.getParameter("name").toUpperCase(); %>
<% } catch(Exception ex){ %>
name 파라미터가 옳지 않습니다.
<% } %>
</body>
</html>
```
위 같은 방법은 익셉션이 발생하면 페이지의 응답 결과 중 일부만 변경해서 이를 출력하는 것이다.   
  
***
# 2. 에러페이지 지정하기
JSP는 실행 도중 익셉션이 발생할 때 지정한 JSP 페이지를 보여줄 수 잇는 기능을 제공하고 있다.    
익셉션이 발생하면 보여줄 JSP 페이지는 ```Page 디렉티브```의 ```errorPage 속성```을 사용해서 지정한다.   
```
<%@ page errorPage="경로" %>
```    
**에러 페이지 예시**
```
<%@ page contentType="text/html; charset=utf-8" %>
<%@ page errorPage="/error/viewErrorMessage.jsp" %>
<html>
<head><title>파라미터 출력</title></head>
<body>

  name 파라미터 값 : <%= request.getParameter("name").toUpperCase() %>

</body>
</html>
```
에러가 발생하면 자동으로 지정한 에러페이지를 출력한다.  

***
# 3. 에러 페이지 작성하기
에러 페이지를 지정하려면 혹은 알리려면 ```page 디렉티브```의 ```isErrorPage 속성```의 값을 ```true``` 로 주어야한다.  
  
**예시 1**
```
<%@ page contentType="text/html; charset=utf-8" %>
<%@ page isErrorPage="true" %>
<html>
<head><title>에러 발생</title></head>
<body>

요청 처리 과정에서 에러가 발생하였습니다. <br>
빠른 시간 내에 문제를 해결하도록 하겠습니다. 
<p>
에러 타입: <%= exception.getClass().getName() %> <br>
에러 메시지: <b><%= exception.getMessage() %> </b>
</body>
</html>
```
이로써 에러가 발생한다면 ```에러 발생``` JSP가 실행되고 이를 출력해서 보여준다.      
또한 어떤 에러가 발생했는지, 그리고 에러 메시지는 무엇인지도 화면에 나타내준다.   
     
하지만 웹 브라우저마다 에러 페이지를 출력하는 기준이 있는데,   
인터넷 익스플로러는    
   
* 응답의 상태 코드가 400, 404나 500등 에러코드이고,  
* 전체 응답 결과 데이터의 길이가 512바이트 보다 작을 대    
  
위와 같은 경우에는 서버에서 전송한 응답 화면이 아닌 자체적으로 제공하는 오류 메시지 화면을 출력한다.     
  
그렇기에 ```512바이트```를 넘겨주도록 JSP 페이지를 작성해 주어야 하는데 방법은 간단하다.  
화면에 표시하고 싶지 않게 크기를 늘리려면 **주석** 을 이용하면 된다.  
  
**예시 2**
```
<%@ page contentType="text/html; charset=utf-8" %>
<%@ page isErrorPage="true" %>
<html>
<head><title>에러 발생</title></head>
<body>

요청 처리 과정에서 에러가 발생하였습니다. <br>
빠른 시간 내에 문제를 해결하도록 하겠습니다. 
<p>
에러 타입: <%= exception.getClass().getName() %> <br>
에러 메시지: <b><%= exception.getMessage() %> </b>
<!-- 
만약 에러 페이지의 길이가 512바이트보다 작다면,
인터넷 익스플로러는 이 페이지가 출력하는 에러 페이지를 출력하지 않고 
자체적으로 제공하는 'HTTP 오류 메시지' 화면을 출력한다.
인터넷 익스플로러에서도 에러 페이지 내용을 올바르게 출력하려면
응답 결과에 이 주석과 같은 내용을 포함해서
에러 데이터가 512바이트를 넘도록 해야 한다.  
-->
</body>
</html>
```
이제 다시 에러를 발생시켜보고 확인해보면  
```512바이트```가 넘으니 현재 다시 작성한 에러페이지가 출력 될 것이다.   
   
***
# 4. 응답 상태 코드별로 에러 페이지 지정하기
웹 서버는 존재하지 않는 페이지에 대한 요청을 받으면 ```404 에러 코드```로 응답한다.  
그리고 이러한 에러 코드에 대해 생성하는 결과 화면이 나오며 이는 웹 서버나 WAS마다 다르다.  
  
실제 서비스를 제공할 땐 각 응답 코드 별로 알맞은 에러 페이지를 보여줄 수 있게 설정해주어야한다.  
JSP/서블릿은 에러 코드별로 사용할 에러페이지를 web.xml 파일에 지정할 수 있다.  
```
<web-app ...>
...

<error-page>
  <error-code>에러코드</error-code>
  <location>에러페이지의 URI</location>
</error-page>

...
</web-app ...>
``` 
  
```<error-page> 태그```는 한 개의 에러 페이지를 지정한다.    
```<error-code> 태그```는 특정 에러 상태 코드를 지정한다.  
```<location> 태그```는 에러 페이지로 사용할 JSP 파일의 경로를 지정한다.  
물론, 경로는 웹 어플리케이션을 현재 디렉토리로 기준을 잡아서 입력하면 된다 .  
  
**예시**
```
<?xml version="1.0" encoding="UTF-8"?>

<web-app ...>
...

<error-page>
  <error-code>404</error-code>
  <location>/error/error404.jsp</location>
</error-page>

<error-page>
  <error-code>500</error-code>
  <location>/error/error500.jsp</location>
</error-page>

...
</web-app ...>
```
  
그리고 이렇게 지정된 JSP파일은 일반 JSP 파일과 동일하게 작성하면 된다.      
(```<%@ page isErrorPage="true"%>```를 할 필요는 없다.)   
다만, 웹 페이지는 ```512바이트```를 넘겨야 하니 주석으로 어느정도의 데이터는 채워주어야한다.    
    
**주요 응답 상태 코드**  
```
HTTP 프로토콜은 응답 상태 코드를 이용해서 서버의 처리 결과를 웹 브라우저에게 알려준다.  

200 : 요청을 정상적으로 처리함
307 : 임시로 페이지를 리다이렉트함
400 : 클라이언트의 요청이 잘못된 구문으로 구성됨
401 : 접근을 허용하지 않음
404 : 요청한 URL을 처리하기 위한 자원이 존재하지 않음
405 : 요청한 메서드(GET/POST/HEAD 등의 전송 방식)를 허용하지 않음
500 : 서버 내부 에러가 발생함(예를 들어, JSP에서 익셉션이 발생함)
503 : 서버가 일시적으로 서비스를 제공할 수 없음(급격하게 부하가 몰리거나 서버가 임시 보수 중인 경우가 해당)

JSP가 정상적으로 실행되는 경우 응답 코드로 200이 전송되며, 
response.sendRedirect()를 이용할 경우 응답 코드로 307을 전송한다.
```
   
***
# 5. 익셉션 타입별로 에러 페이지 지정하기
JSP 페이지에서 발생하는 익셉션 종류별로 에러 페이지를 지정할 수도 있다.  
```
<web-app ...>
...

<error-page>
  <exception-type>익셉션클래스</exception-type>
  <location>에러페이지의 URI</location>
</error-page>

...
</web-app ...>
``` 
**예시**
```
<web-app ...>
...

<error-page>
  <exception-type>java.lang.NullPointerException</exception-type>
  <location>/error/errorNullPointer.jsp</location>
</error-page>

...
</web-app ...>
```
   
***
# 6. 에러 페이지의 우선순위와 에러 페이지 지정 형태
에러 페이지를 여러 방법으로 지정한 경우 우선순위에 따라 사용할 에러 페이지를 선택한다.  

**우선순위**  
1. page 디렉티브의 errorPage 속성에 지정한 에러 페이지를 보여준다.  
2. JSP 페이지에서 발생한 익셉션 타입에 맞는 web.xml에 지정한 에러 페이지를 보여준다.  
3. 에러코드가 맞는 web.xml에 지정한 에러 페이지를 보여준다.
4. 아무것도 해당하지 않는 경우 웹 컨테이너가 제공하는 기본 에러 페이지를 보여준다.  
  
그래서 우선순위를 고려해서 에러페이지를 지정한다.  
  
**지정 순서**   
* 전용 에러 페이지가 필요한 경우 page 디렉티브의 errorPage 속성을 사용해서 에러 페이지를 지정한다.  
* 범용적인 에러 코드에 대해 web.xml에 에러 페이지를 지정한다.  
* 별도로 처리해야 하는 익셉션 타입에 대해서는 web.xml에 태그를 추가해서 에러 페이지를 지정한다.  
   
***
# 7. 버퍼와 에러 페이지의 관계
버퍼가 다차면 버퍼의 내용을 웹 브라우저에 전달하는데,  
처음 버퍼를 플러시 할 때 응답 헤더를 전송한다고 했다.  
하지만 사실상 응답 상태 코드가 응답 헤더 앞에 전송되므로 **최초로 전송되는 것은 응답 상태 코드**이다.  
따라서 버퍼를 최초로 플러시 할 때까지 에러가 발생하지 않으면 웹 브라우저에 ```200 응답 상태 코드```가 전송된다.  
  
이런 이유로 에러 응답 코드와 에러 페이지의 내용을 웹 브라우저에 완전하게 전송하려면 버퍼가 플러시되면 안된다.  
만약 **버퍼가 플러시 된 이후에 에러가 발생하면**  
웹 브라우저에 이미 ```200 응답 상태 코드```와 일부 응답 결과 화면이 전송되기 때문에,  
일부 페이지의 내용이 웹 브라우저에 출력되고 그 뒤에 에러 페이지의 내용이 붙게된다.   
  
또한 익셉션이 발생하면 응답 상태 코드가 ```500```이 되어야 하는데  
```200 응답 상태 코드```를 전송했기 때문에 웹 브라우저는 정상적으로 응답이 도착했다고 판단한다.  
    
따라서 익셉션이 발생하기 전에 버퍼가 플러시 될 가능성이 있다면     
버퍼 크기를 늘려서 에러가 발생하기 전에 버퍼가 플러시 되지 않도록 해야한다.     
